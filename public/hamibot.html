<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hamibot脚本执行</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input[type="radio"] { margin-right: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #0056b3; }
        .log-container { margin-top: 30px; }
        .log-title { font-size: 18px; margin-bottom: 10px; }
        .log-content { height: 300px; background: #fff; border: 1px solid #ddd; padding: 10px; overflow-y: auto; white-space: pre-wrap; }
        .radio-group { display: flex; gap: 15px; margin-top: 5px; }
    </style>
    <link rel="stylesheet" href="/css/float-nav.css">
</head>
<body>
    <div class="container">
        <h1>Hamibot脚本执行</h1>
        <form id="hamibotForm">
            <div class="form-group">
                <label for="mobile">手机选择（必填）：</label>
                <select id="mobile" name="mobile" required>
                    <option value="">加载中...</option>
                </select>
            </div>
            <div class="form-group">
                <label>网速选择（必填）：</label>
                <div class="radio-group">
                    <label><input type="radio" name="speed" value="a" checked> 普通</label>
                    <label><input type="radio" name="speed" value="b"> 慢</label>
                </div>
            </div>
            <button type="submit">开始调用远程脚本</button>
            <button type="button" id="stopAllTasks" style="background: #dc3545;margin-top: 10px;">停止所有任务</button>
        </form>

        <div class="log-container">
            <div class="log-title">执行日志：</div>
            <div id="logContent" class="log-content"></div>
        </div>
    </div>

    <script>
        // 添加全局变量存储轮询ID
        let logIntervalId = null;

        // 获取移动设备列表
        async function loadMobileDevices() {
            try {
                // 从localStorage获取token
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }
                const response = await fetch('/api/mobiles', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!response.ok) throw new Error('获取设备列表失败');
                const mobiles = await response.json();
                const select = document.getElementById('mobile');
                select.innerHTML = mobiles.map(m => `<option value="${m.mobile}">${m.mobile}</option>`).join('');
            } catch (error) {
                addLog('错误：' + error.message);
            }
        }

        // 获取Cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // 添加日志
        let logEntries = []; // 日志存储数组
        const MAX_LOG_ENTRIES = 100; // 最大日志条数
        
        function addLog(message) {
            const logElement = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
        
            // 添加新日志并维持FIFO队列
            logEntries.push(logEntry);
            if (logEntries.length > MAX_LOG_ENTRIES) {
                logEntries.shift(); // 移除最早的日志
            }
        
            // 渲染日志（使用数组join避免多次innerHTML操作）
            logElement.innerHTML = logEntries.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 修改轮询函数，添加停止条件
        function startLogPolling() {
            // 先清除可能存在的轮询
            if (logIntervalId) clearInterval(logIntervalId);

            // 使用变量存储interval ID以便后续清理
            logIntervalId = setInterval(async () => {
                try {
                    // 从localStorage获取token
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = '/login.html';
                        clearInterval(logIntervalId);
                        logIntervalId = null;
                        return;
                    }
                    const response = await fetch('/api/hamibot/log', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    if (!response.ok) throw new Error('获取日志失败');
                    const logData = await response.json();
                    addLog('任务队列状态：' + logData.queueLength + '个任务待处理' + '，当前处理任务数：' + Number(logData.isProcessingQueue));
                    logData.tasks.forEach(task => {
                        addLog(`任务 ${task.id}: ${task.status} ${task.error ? '错误：' + task.error : ''}`);
                    });

                    // 检查是否需要停止轮询
                    if (!logData.isProcessingQueue && logData.queueLength === 0) {
                        addLog('所有任务已处理完成，停止日志轮询');
                        clearInterval(logIntervalId);
                        logIntervalId = null;
                    }
                } catch (error) {
                    addLog('日志获取错误：' + error.message);
                    // 发生错误时停止轮询
                    clearInterval(logIntervalId);
                    logIntervalId = null;
                }
            }, 15000); // 15秒轮询一次

            return logIntervalId;
        }

        // 停止所有任务
        async function stopAllTasks() {
            try {
                addLog('正在停止所有任务...');
                // 从localStorage获取token
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/login.html';
                    return;
                }
                const response = await fetch('/api/hamibot/stop', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                if (!response.ok) throw new Error('停止任务请求失败');
                const result = await response.json();
                addLog(result.message);
            } catch (error) {
                addLog('停止任务错误：' + error.message);
            }
        }

        // 绑定停止按钮事件
        document.getElementById('stopAllTasks').addEventListener('click', stopAllTasks);

        // 表单提交处理
        document.getElementById('hamibotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const mobile = document.getElementById('mobile').value;
            const speed = document.querySelector('input[name="speed"]:checked').value;
            // 从localStorage获取token
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            try {
                addLog('开始执行脚本...');
                const response = await fetch('/api/hamibot/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ mobile, speed })
                });

                if (!response.ok) throw new Error('提交失败');
                const result = await response.json();
                addLog('提交成功：' + result.message);
                
                // 表单提交成功后开始日志轮询
                addLog('开始监控任务执行状态...');
                startLogPolling();
            } catch (error) {
                addLog('提交错误：' + error.message);
            }
        });

        // 页面加载时初始化 - 移除自动启动轮询
        window.onload = () => {
            loadMobileDevices();
            addLog('系统就绪，等待操作...');
        };
    </script>
    <script src="/js/float-nav.js"></script>
    <script>
        // 初始化浮动导航，当前页面为hamibot
        initFloatNav('hamibot');
    </script>
</body>
</html>